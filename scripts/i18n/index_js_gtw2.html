<html lang="en">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<head>
<script type="text/javascript" src="head.load.min.js"></script>
<style>
body { 
	text-align: center; font-family: Helvetica, Arial, sans-serif; font-size: 13px;
}
* { color: #555; text-shadow: #fff 0 1px 0px; }
h3 { color: #333; font-size: 16px; margin-bottom: 0; padding-bottom: 0; }
a.button { display: block; padding: 11px; background: #fff; border: 1px solid #ababab; border-bottom: 0; font-weight: bold; color: #000; text-decoration: none; font-size: 16px; margin: 0 1px; }
a.button.top-rounded { border-top-left-radius: 10px; border-top-right-radius: 10px; }
a.button.bottom-rounded { border-bottom: 1px solid #ababab; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; }

</style>
<script>
// http://www.kristallum.com/docs/_gt_i18n_4trans.html
// file:///C:/_WPLabs/PROJECTS_GAMES/Dropbox/docs/_tools/i18n/index_js_gtw2.html
function initClient() {
	$(document).ready(function(e){
	});
}

var interchars=" .,;";
function convJs2Xml() {
	jsonst = $('#part_js_src').val()+"|";
	var gwt_result = "";
	var linecombine_begin = -1;
	var linecombine_end = -1;
	var is_ru_found = 0;
	var valid_linechars = " .,#'0123456789";
	for(var i=0;i<jsonst.length;i++){
		var cha_id = jsonst.charCodeAt(i);
		var cha = jsonst.charAt(i);
		//gwt_result += " dbg"+cha_id;
		if(cha_id > 127 || valid_linechars.indexOf(cha) >= 0){
			if(cha_id > 127){
				is_ru_found++;
			}
			if(linecombine_begin<0){
				if(is_ru_found > 0){
					linecombine_begin = i;
					linecombine_end = i+1;
				}
			}else{
				if(cha_id > 127){
					linecombine_end = i+1;
				}
			}
		}else{
			if(linecombine_begin>=0){
				var ln = jsonst.substr(linecombine_begin,linecombine_end-linecombine_begin);
				ln = trimlr(ln," \t\n");
				gwt_result += "<p>";
				gwt_result += "((S"+linecombine_begin+","+linecombine_end+"))";
				gwt_result += "&nbsp;<nobr>";
				gwt_result += ln;
				gwt_result += "</nobr>&nbsp;";
				gwt_result += "((E"+linecombine_begin+","+linecombine_end+"))";
				gwt_result += "</p>\n\n";
				linecombine_begin = -1;
				linecombine_end = -1;
				is_ru_found = 0;
			}
		}
	}
	$('#part_gwt').val(gwt_result);
}

function convXml2Js() {
	jsonst = $('#part_js_src').val();
	gwtst = $('#part_gwt').val();
	i18led = jsonst;
	// List of all replaces
	var all_replaces = [];
	var replmark = gwtst.indexOf("((S");
	while(replmark >= 0){
		var replmakend = gwtst.indexOf("))", replmark+1);
		if(replmakend >= 0){
			var begend_pair = gwtst.substr(replmark+3,replmakend-(replmark+3));
			var translation = str_between(gwtst,"((S"+begend_pair+"))","((E"+begend_pair+"))");
			var be_p2 = begend_pair.split(",");
			var pair_l = [parseInt(be_p2[0]),parseInt(be_p2[1]),trimlr(translation," \t\n")];
			all_replaces.push(pair_l);
		}
		replmark = gwtst.indexOf("((S", replmark+1);
	}
	//i18led = all_replaces.join("\n");
	for(i=all_replaces.length-1;i>=0;i--){
		var ppr = all_replaces[i];
		i18led = i18led.substr(0,ppr[0])+ppr[2]+i18led.substr(ppr[1]);
	}
	$('#part_output').val(i18led);
}

// =====================================
function utf8_to_b64( str ) {
  return window.btoa(unescape(encodeURIComponent( str )));
}

function b64_to_utf8( str ) {
	str = full_replace(str," ","");
	if(str == null || str.length == 0){
		return null;
	}
	try{
		return decodeURIComponent(escape(window.atob( str )));
	}catch(e){
		//alert("Failed to atob: "+str);
	}
	return null;
}

var makeCRCTable = function(){
    var c;
    var crcTable = [];
    for(var n =0; n < 256; n++){
        c = n;
        for(var k =0; k < 8; k++){
            c = ((c&1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));
        }
        crcTable[n] = c;
    }
    return crcTable;
}

var crc32 = function(str) {
    var crcTable = window.crcTable || (window.crcTable = makeCRCTable());
    var crc = 0 ^ (-1);

    for (var i = 0; i < str.length; i++ ) {
        crc = (crc >>> 8) ^ crcTable[(crc ^ str.charCodeAt(i)) & 0xFF];
    }

    return (crc ^ (-1)) >>> 0;
};

function x_crc32(s) {
	var res = 10000;
	var ii = 0;
	for(var i=0;i<s.length;i++){
		var ccode = s.charCodeAt(i);
		if(ccode>127){
			if(ii%2 == 0){
				res += ccode;
			}else{
				res -= ccode;
			}
			ii++;
		}
	}
	return res;
}

// =====================================
function trimlr(s, rmchars) {
	var res = s;
	for(var i=0;i<s.length;i++){
		var cc = s.charAt(i);
		if(rmchars.indexOf(cc) < 0){
			res = s.substr(i);
			break;
		}
	}
	for(var i=res.length-1;i >= 0;i--){
		var cc = res.charAt(i);
		if(rmchars.indexOf(cc) < 0){
			res = res.substr(0,i+1);
			break;
		}
	}
	return res;
}

function full_replace(what, search, replace) {
	return what.split(search).join(replace);
}

function single_replace(s, sfor, sto) {
	var idx = s.indexOf(sfor);
	if(idx>=0){
		var sleft = s.substr(0,idx);
		var sright = s.substr(idx+sfor.length);
		return sleft+sto+sright;
	}
	return null;
}

function str_between(s, sleft, sright) {
	var idx = s.indexOf(sleft);
	if(idx>=0){
		idx += sleft.length;
		var idx2 = s.indexOf(sright,idx);
		if(idx2>=0){
			return s.substr(idx,idx2-idx);
		}
	}
	return '';
}

// =====================================
// =====================================
head.js("jquery-1.7.1.min.js","jquery.json-2.2.min.js",initClient);
</script>
</head>
<body scroll="no" class="bg">
<center>
<table width=100%>
<tr><td valign="top" width="70%">JS source
<div id="part_js" style="width:100%;height:200px;">
<textarea id="part_js_src" style="width:100%;height:200px;">
</textarea>
</div>
<td valign="top">JS Translated
<div id="part_trx" style="width:100%;height:200px;">
<textarea id="part_output" style="width:100%;height:200px;">
</textarea>
</div>
</table>
<input type="button" value="JS to GWT" onClick="convJs2Xml();">&nbsp;|&nbsp;<input type="button" value="GWT to JS" onClick="convXml2Js();">
<br><br>
GWT output
<div id="part_xml" style="width:100%;height:200px;">
<textarea id="part_gwt" style="width:100%;height:200px;">
</textarea>
</div>
</center>
</body>
</html>